#### Household Expenditures ###

library(tidyverse)
library(cansim)
library(xlsx)
library(lubridate)
library(formattable)
library(ggthemes)
# library(extrafont)
library(scales)

### Functions and Values ---

# ---- A function to trim the right side of a string ---- #

substrRight <- function(x, n){
  substr(x, nchar(x)-n+1, nchar(x))
}


### 
a <- get_cansim("11-10-0222")

names(a)

# Rename variables that I intend to keep,
colnames(a)[5] <- c("Expenditure_Categories")
colnames(a)[21] <- c("Expenditure_Cat_Hierarchy")


## categories
a1 <- subset(a, a$GEO == "Canada" & a$REF_DATE == "2017", 
             select = c("Expenditure_Cat_Hierarchy", 
                        "Expenditure_Categories"))

write.xlsx(a1, 
           file ="data/Expenditure_categories.xlsx",
           sheetName = "DATA",
           col.names = TRUE,
           row.names = TRUE,
           append = FALSE)

### Finish cleansing the data

a$REF_DATE <- as.numeric(a$REF_DATE)

unique(a$Expenditure_Categories)

unique(a$Statistic)

a$Expenditure_Categories <- as.factor(a$Expenditure_Categories)

names(a)
a

## see evolution of overall expenditures

## Canada and provinces.
p1a <- a %>%
  filter(Expenditure_Categories == "Total expenditure" ) %>%
  ggplot(aes(x = REF_DATE, y = round(VALUE/1000,1), color = GEO))+
  geom_point() +
  geom_line() +
 # ylim(500, 1500)+
     facet_wrap (~GEO)+
 # geom_text(aes(label = GEO), vjust = -1) +
  theme_bw()+
  theme(legend.position = "bottom") +
  theme(legend.title = element_blank())+
  labs(x = "Year",
       y = "Average expenditure per household (thousand of dollars) ",
       title = "Average expenditure per household (thousands of dollars) by Geography",
       caption = paste("Source: Statistics Canada, Table 11-10-0222-01"))


p1a

ggsave(plot = p1a,
       filename = "images/Avg_Expend_by_Geo.jpg", 
       device = "jpg",
       dpi = 600)


### manitoba
p1b <- a %>%
  filter(Expenditure_Categories == "Total expenditure" &
           GEO == "Manitoba") %>%
  ggplot(aes(x = REF_DATE, y = round(VALUE/1000,1), color = GEO))+
  geom_point() +
  geom_line() +
  ylim(60, 90)+
  facet_wrap (~GEO)+
   geom_text(aes(label = round(VALUE/1000,1)), vjust = -1) +
  theme_bw()+
  theme(legend.position = "bottom") +
  theme(legend.title = element_blank())+
  labs(x = "Year",
       y = "Average expenditure per household (thousand of dollars) ",
       title = "Average expenditure per household (thousands of dollars) by Geography",
       caption = paste("Source: Statistics Canada, Table 11-10-0222-01"))


p1b

ggsave(plot = p1b,
       filename = "images/Avg_Expend_by_MB.jpg", 
       device = "jpg",
       dpi = 600)

names(a)

### pull out Manitoba

b <- subset(a, GEO == "Manitoba", select =
              c("REF_DATE", "GEO", "Expenditure_Categories",   
                "VALUE",  "Expenditure_Cat_Hierarchy")
            )

b

#### EXPENDITURE LEVELS ########################

### pull out Total expenditures and then add it back to the MB data as a new column.
Expend_lvl <- unique(b$Expenditure_Cat_Hierarchy)

### lvl 01 ##
Exp_Hier_01_lvl <- {c("1", 
                     "1.2", 
                     "1.40", 
                     "1.41", 
                     "1.42")}

### lvl 02 ##
Exp_Hier_02_lvl <- {c("1.2.3", 
                     "1.2.6", 
                     "1.2.12", 
                     "1.2.14", 
                     "1.2.18", 
                     "1.2.23", 
                     "1.2.26", 
                     "1.2.29", 
                     "1.2.30", 
                     "1.2.35", 
                     "1.2.36", 
                     "1.2.37", 
                     "1.2.38", 
                     "1.2.39", 
                     "1.41.307", 
                     "1.41.308", 
                     "1.41.309", 
                     "1.41.310", 
                     "1.42.311", 
                     "1.42.315")}

### lvl 03 ##
Exp_Hier_03_lvl <- {c("1.2.3.4", 
                     "1.2.3.5", 
                     "1.2.6.7", 
                     "1.2.6.11", 
                     "1.2.12.13", 
                     "1.2.12.90", 
                     "1.2.12.91", 
                     "1.2.12.95", 
                     "1.2.12.99", 
                     "1.2.12.103", 
                     "1.2.12.107", 
                     "1.2.12.108", 
                     "1.2.14.15", 
                     "1.2.14.16", 
                     "1.2.14.128", 
                     "1.2.14.129", 
                     "1.2.18.132", 
                     "1.2.18.141", 
                     "1.2.18.150", 
                     "1.2.18.153", 
                     "1.2.18.154", 
                     "1.2.18.155", 
                     "1.2.23.24", 
                     "1.2.23.25", 
                     "1.2.26.27", 
                     "1.2.26.203", 
                     "1.2.29.207", 
                     "1.2.29.217", 
                     "1.2.30.31", 
                     "1.2.30.32", 
                     "1.2.30.33", 
                     "1.2.30.34", 
                     "1.2.35.267", 
                     "1.2.35.273", 
                     "1.2.36.274", 
                     "1.2.36.275", 
                     "1.2.36.276", 
                     "1.2.36.277", 
                     "1.2.36.278", 
                     "1.2.37.279", 
                     "1.2.37.282", 
                     "1.2.38.286", 
                     "1.2.38.287", 
                     "1.2.39.290", 
                     "1.2.39.295", 
                     "1.42.311.312", 
                     "1.42.311.313", 
                     "1.42.311.314")}

### lvl 04 ##
Exp_Hier_04_lvl <- {c("1.2.3.4.43", 
                     "1.2.3.4.44", 
                     "1.2.3.4.45", 
                     "1.2.3.4.46", 
                     "1.2.3.4.47", 
                     "1.2.3.4.48", 
                     "1.2.3.4.49", 
                     "1.2.3.4.50", 
                     "1.2.3.5.51", 
                     "1.2.3.5.52", 
                     "1.2.6.7.8", 
                     "1.2.6.7.9", 
                     "1.2.6.7.10", 
                     "1.2.6.11.73", 
                     "1.2.6.11.79", 
                     "1.2.6.11.80", 
                     "1.2.12.13.83", 
                     "1.2.12.13.87", 
                     "1.2.12.13.88", 
                     "1.2.12.13.89", 
                     "1.2.12.91.92", 
                     "1.2.12.91.93", 
                     "1.2.12.91.94", 
                     "1.2.12.95.96", 
                     "1.2.12.95.98", 
                     "1.2.12.95.97", 
                     "1.2.12.99.100", 
                     "1.2.12.99.101", 
                     "1.2.12.99.102", 
                     "1.2.12.103.104", 
                     "1.2.12.103.105", 
                     "1.2.12.103.106", 
                     "1.2.12.108.109", 
                     "1.2.12.108.110", 
                     "1.2.14.15.111", 
                     "1.2.14.15.112", 
                     "1.2.14.15.113", 
                     "1.2.14.15.114", 
                     "1.2.14.15.115", 
                     "1.2.14.16.17", 
                     "1.2.14.16.123", 
                     "1.2.14.129.130", 
                     "1.2.14.129.131", 
                     "1.2.18.132.133", 
                     "1.2.18.132.134", 
                     "1.2.18.132.137", 
                     "1.2.18.132.138", 
                     "1.2.18.141.142", 
                     "1.2.18.141.143", 
                     "1.2.18.141.146", 
                     "1.2.18.141.147", 
                     "1.2.18.150.151", 
                     "1.2.18.150.152", 
                     "1.2.18.155.156", 
                     "1.2.18.155.157", 
                     "1.2.18.155.158", 
                     "1.2.23.24.159", 
                     "1.2.23.24.170", 
                     "1.2.23.24.171", 
                     "1.2.23.25.183", 
                     "1.2.23.25.184", 
                     "1.2.23.25.185", 
                     "1.2.23.25.186", 
                     "1.2.23.25.187", 
                     "1.2.23.25.188", 
                     "1.2.23.25.189", 
                     "1.2.26.27.190", 
                     "1.2.26.27.191", 
                     "1.2.26.27.192", 
                     "1.2.26.27.197", 
                     "1.2.26.27.201", 
                     "1.2.26.203.204", 
                     "1.2.26.203.205", 
                     "1.2.26.203.206", 
                     "1.2.29.207.208", 
                     "1.2.29.207.209", 
                     "1.2.29.207.212", 
                     "1.2.29.207.213", 
                     "1.2.29.207.214", 
                     "1.2.29.207.215", 
                     "1.2.29.207.216", 
                     "1.2.29.217.218", 
                     "1.2.29.217.219", 
                     "1.2.30.31.220", 
                     "1.2.30.31.221", 
                     "1.2.30.31.222", 
                     "1.2.30.31.223", 
                     "1.2.30.31.224", 
                     "1.2.30.31.225", 
                     "1.2.30.31.229", 
                     "1.2.30.31.232", 
                     "1.2.30.31.233", 
                     "1.2.30.32.234", 
                     "1.2.30.32.242", 
                     "1.2.30.33.245", 
                     "1.2.30.33.252", 
                     "1.2.30.33.255", 
                     "1.2.30.33.256", 
                     "1.2.30.34.257", 
                     "1.2.30.34.262", 
                     "1.2.35.267.268", 
                     "1.2.35.267.269", 
                     "1.2.35.267.270", 
                     "1.2.35.267.271", 
                     "1.2.35.267.272", 
                     "1.2.37.279.280", 
                     "1.2.37.279.323", 
                     "1.2.37.279.281", 
                     "1.2.37.282.283", 
                     "1.2.37.282.284", 
                     "1.2.37.282.285",  
                     "1.2.38.287.288", 
                     "1.2.38.287.289", 
                     "1.2.39.290.291", 
                     "1.2.39.290.292", 
                     "1.2.39.290.293", 
                     "1.2.39.290.294", 
                     "1.2.39.295.296", 
                     "1.2.39.295.297", 
                     "1.2.39.295.298", 
                     "1.2.39.295.299", 
                     "1.2.39.295.300", 
                     "1.2.39.295.301", 
                     "1.2.39.295.302", 
                     "1.2.39.295.303", 
                     "1.2.39.295.304", 
                     "1.2.39.295.305", 
                     "1.2.39.295.306")}

### lvl 05 ##
Exp_Hier_05_lvl <- {c("1.2.6.7.8.53", 
                     "1.2.6.7.8.54", 
                     "1.2.6.7.8.55", 
                     "1.2.6.7.8.56", 
                     "1.2.6.7.9.57", 
                     "1.2.6.7.9.58", 
                     "1.2.6.7.9.59", 
                     "1.2.6.7.9.60", 
                     "1.2.6.7.9.61", 
                     "1.2.6.7.9.62", 
                     "1.2.6.7.10.69", 
                     "1.2.6.7.10.70", 
                     "1.2.6.7.10.71", 
                     "1.2.6.7.10.72", 
                     "1.2.6.11.73.74", 
                     "1.2.6.11.73.318", 
                     "1.2.6.11.73.76", 
                     "1.2.6.11.73.319", 
                     "1.2.6.11.73.320", 
                     "1.2.6.11.73.78", 
                     "1.2.6.11.80.81", 
                     "1.2.6.11.80.82", 
                     "1.2.12.13.83.84", 
                     "1.2.12.13.83.85", 
                     "1.2.12.13.83.86", 
                     "1.2.14.16.17.116", 
                     "1.2.14.16.17.117", 
                     "1.2.14.16.17.118", 
                     "1.2.14.16.17.119", 
                     "1.2.14.16.17.120", 
                     "1.2.14.16.17.121", 
                     "1.2.14.16.17.122", 
                     "1.2.14.16.123.124", 
                     "1.2.14.16.123.125", 
                     "1.2.14.16.123.126", 
                     "1.2.14.16.123.127", 
                     "1.2.18.132.134.135", 
                     "1.2.18.132.134.136", 
                     "1.2.18.132.138.139", 
                     "1.2.18.132.138.140", 
                     "1.2.18.141.143.144", 
                     "1.2.18.141.143.145", 
                     "1.2.18.141.147.148", 
                     "1.2.18.141.147.149", 
                     "1.2.23.24.159.160", 
                     "1.2.23.24.159.164", 
                     "1.2.23.24.159.165", 
                     "1.2.23.24.171.172", 
                     "1.2.23.24.171.173", 
                     "1.2.23.24.171.174", 
                     "1.2.23.24.171.175", 
                     "1.2.23.24.171.176", 
                     "1.2.23.24.171.177", 
                     "1.2.23.24.171.179", 
                     "1.2.23.24.171.178", 
                     "1.2.23.24.171.180", 
                     "1.2.26.27.192.193", 
                     "1.2.26.27.192.194", 
                     "1.2.26.27.192.195", 
                     "1.2.26.27.192.196", 
                     "1.2.26.27.197.198", 
                     "1.2.26.27.197.199", 
                     "1.2.26.27.197.200", 
                     "1.2.29.207.209.210", 
                     "1.2.29.207.209.211", 
                     "1.2.30.31.225.226", 
                     "1.2.30.31.225.227", 
                     "1.2.30.31.225.228", 
                     "1.2.30.31.225.317", 
                     "1.2.30.31.225.321", 
                     "1.2.30.31.225.322", 
                     "1.2.30.31.229.230", 
                     "1.2.30.31.229.231", 
                     "1.2.30.32.234.235", 
                     "1.2.30.32.234.236", 
                     "1.2.30.32.234.240", 
                     "1.2.30.32.234.241", 
                     "1.2.30.32.242.243", 
                     "1.2.30.32.242.244", 
                     "1.2.30.33.245.246", 
                     "1.2.30.33.245.247", 
                     "1.2.30.33.245.248", 
                     "1.2.30.33.245.249", 
                     "1.2.30.33.252.253", 
                     "1.2.30.33.252.254", 
                     "1.2.30.34.257.258", 
                     "1.2.30.34.257.259", 
                     "1.2.30.34.257.261", 
                     "1.2.30.34.257.260", 
                     "1.2.30.34.262.263", 
                     "1.2.30.34.262.264", 
                     "1.2.30.34.262.265", 
                     "1.2.30.34.262.266")}

### lvl 06 ##
Exp_Hier_06_lvl <- {c("1.2.6.7.9.62.63", 
                     "1.2.6.7.9.62.64", 
                     "1.2.6.7.9.62.65", 
                     "1.2.6.7.9.62.67", 
                     "1.2.6.7.9.62.68", 
                     "1.2.6.7.9.62.316", 
                     "1.2.23.24.159.160.161",
                     "1.2.23.24.159.160.162", 
                     "1.2.23.24.159.160.163", 
                     "1.2.23.24.159.165.166",
                     "1.2.23.24.159.165.169", 
                     "1.2.23.24.171.180.181", 
                     "1.2.23.24.171.180.182", 
                     "1.2.30.32.234.236.237", 
                     "1.2.30.32.234.236.238", 
                     "1.2.30.32.234.236.239")}

### lvl 07 ##
Exp_Hier_07_lvl <- {c("1.2.23.24.159.165.166.167", 
                     "1.2.23.24.159.165.166.168")}


#### EXPENDITURE FUNCTIONS #########################

########## Function 01 ##
Exp_fn_lvl01 <- function(element) {
  ## This groups the highest and second-level codes
  forcats::fct_collapse(element,
                        "Total Expenditure" = 
                          c("1"),
                        
                        "Total Current Consumption" = 
                          c("1.2"),
                        
                        "Income Taxes" = 
                          c("1.40"),
                        
                        "Personal Insurance Payments and Pension Contributions" = 
                          c("1.41"),
                        
                        "Gifts of Money, support payments and charitable contributions" = 
                          c("1.42")
                        )}

########## Function 02 ##
Exp_fn_lvl02 <- function(element) {
  ## This groups the highest and second-level codes
  forcats::fct_collapse(element,
                        "Total current consumption" = 
                          c("1.2.3", 
                            "1.2.6", 
                            "1.2.12", 
                            "1.2.14", 
                            "1.2.18", 
                            "1.2.23",
                            "1.2.26", 
                            "1.2.29", 
                            "1.2.30", 
                            "1.2.35", 
                            "1.2.36", 
                            "1.2.37", 
                            "1.2.38", 
                            "1.2.39"), 
                        
                        "Personal insurance payments and pension contributions" = 
                           c("1.41.307", 
                             "1.41.308", 
                             "1.41.309", 
                             "1.41.310"),
                        
                        "Gifts of money, support payments and charitable contributions" = 
                           c("1.42.311", 
                             "1.42.315")
                        )}

########## Function 03 ##
Exp_fn_lvl03 <- function(element) {
  ## This groups the third-level codes
  forcats::fct_collapse(element,
                        "Food expenditures" = 
                          c("1.2.3.4", 
                            "1.2.3.5"), 
                        
                        "Shelter" = 
                          c("1.2.6.7", 
                            "1.2.6.11"), 
                        
                        "Household operations" = 
                          c("1.2.12.13", 
                            "1.2.12.90", 
                            "1.2.12.91", 
                            "1.2.12.95", 
                            "1.2.12.99", 
                            "1.2.12.103", 
                            "1.2.12.107", 
                            "1.2.12.108"), 
                        
                        "Household furnishings and equipment" = 
                          c("1.2.14.15", 
                            "1.2.14.16", 
                            "1.2.14.128", 
                            "1.2.14.129"), 
                        
                        "Clothing and acccessories" = 
                          c("1.2.18.132", 
                            "1.2.18.141", 
                            "1.2.18.150",  
                            "1.2.18.153", 
                            "1.2.18.154",  
                            "1.2.18.155"),
                        
                        "Transportation" = 
                          c("1.2.23.24", 
                            "1.2.23.25"), 
                        
                        "Health care" = 
                          c("1.2.26.27", 
                            "1.2.26.203"), 
                        
                        "Personal care" = 
                          c("1.2.29.207", 
                            "1.2.29.217"), 
                        
                        "Recreation" = 
                          c("1.2.30.31", 
                            "1.2.30.32", 
                            "1.2.30.33", 
                            "1.2.30.34"), 
                            
                        "Education" = 
                          c("1.2.35.267", 
                            "1.2.35.273"), 
                        
                        "Reading materials and other printed matter" =  
                          c("1.2.36.274", 
                            "1.2.36.275", 
                            "1.2.36.276", 
                            "1.2.36.277", 
                            "1.2.36.278"), 
                        
                        "Tobacco products and alcoholic beverages" =    
                            c("1.2.37.279", 
                              "1.2.37.282"), 
                         
                        "Game of chance" =   
                            c("1.2.38.286", 
                              "1.2.38.287"), 
                        
                        "Miscellaneous expenditures" =    
                            c("1.2.39.290", 
                              "1.2.39.295"), 
                        
                        "Gifts of money and support payments" =
                            c("1.42.311.312", 
                              "1.42.311.313", 
                              "1.42.311.314")
                        )}

########## Function 04 ##
Exp_fn_lvl04 <- function(element) {
  ## This groups the fourth-level codes
  forcats::fct_collapse(element,
                        "Food purchased from stores" = 
                          c("1.2.3.4.43", 
                            "1.2.3.4.44", 
                            "1.2.3.4.45", 
                            "1.2.3.4.46", 
                            "1.2.3.4.47", 
                            "1.2.3.4.48", 
                            "1.2.3.4.49", 
                            "1.2.3.4.50"), 
                            
                        "Food purchased from restaurants" =
                          c("1.2.3.5.51", 
                            "1.2.3.5.52"), 
                            
                        "Principal accommodation" =    
                          c("1.2.6.7.8", 
                            "1.2.6.7.9", 
                            "1.2.6.7.10"),
                        
                        "Other accomodation" =
                          c("1.2.6.11.73", 
                            "1.2.6.11.79", 
                            "1.2.6.11.80"), 
                        
                        "Communications" =
                          C("1.2.12.13.83", 
                            "1.2.12.13.87", 
                            "1.2.12.13.88", 
                            "1.2.12.13.89"), 
                        
                        "Pet expenses" =
                          c("1.2.12.91.92", 
                            "1.2.12.91.93", 
                            "1.2.12.91.94"), 
                        
                        "Household cleaning supplies and equiment" =    
                          c("1.2.12.95.96", 
                            "1.2.12.95.98", 
                            "1.2.12.95.97"), 
                        
                        "Paper, plastic and foil supplies" =
                          c("1.2.12.99.100", 
                            "1.2.12.99.101", 
                            "1.2.12.99.102"),
                        
                        "Garden supplies and services" =
                          c("1.2.12.103.104", 
                            "1.2.12.103.105", 
                            "1.2.12.103.106"), 
                        
                        "Child care" =
                          c("1.2.12.108.109", 
                            "1.2.12.108.110"),
                        
                        "Household furnishings" =
                          c("1.2.14.15.111", 
                            "1.2.14.15.112", 
                            "1.2.14.15.113", 
                            "1.2.14.15.114", 
                            "1.2.14.15.115"), 
                        
                        "Household equipment" =    
                          c("1.2.14.16.17", 
                            "1.2.14.16.123"), 
                        
                        "Services related to household furnishing and equipment" =
                          c("1.2.14.129.130", 
                            "1.2.14.129.131"),
                        
                        "Women's and girls' wear (4 yrs+)" =
                          c("1.2.18.132.133", 
                            "1.2.18.132.134", 
                            "1.2.18.132.137", 
                            "1.2.18.132.138"), 
                        
                        "Men's and boys' wear (4 years+)" =  
                          c("1.2.18.141.142", 
                            "1.2.18.141.143", 
                            "1.2.18.141.146", 
                            "1.2.18.141.147"), 
                        
                        "Children's wear (under 4 years)" = 
                          c("1.2.18.150.151", 
                            "1.2.18.150.152"), 
                          
                        "Clothing services" =  
                          c("1.2.18.155.156", 
                            "1.2.18.155.157", 
                            "1.2.18.155.158"), 
                        
                        "Private transportation" =
                          c("1.2.23.24.159", 
                            "1.2.23.24.170", 
                            "1.2.23.24.171"), 
                            
                        "Public transportation" =
                          c("1.2.23.25.183", 
                            "1.2.23.25.184", 
                            "1.2.23.25.185", 
                            "1.2.23.25.186", 
                            "1.2.23.25.187", 
                            "1.2.23.25.188", 
                            "1.2.23.25.189"), 
                        
                        "Direct health care costs to household" =
                          c("1.2.26.27.190", 
                            "1.2.26.27.191", 
                            "1.2.26.27.192", 
                            "1.2.26.27.197", 
                            "1.2.26.27.201"), 
                        
                       "Private health insurance plan premiums" = 
                          c("1.2.26.203.204", 
                            "1.2.26.203.205", 
                            "1.2.26.203.206"), 
                        
                        "Personal care products" =
                          c("1.2.29.207.208", 
                            "1.2.29.207.209", 
                            "1.2.29.207.212", 
                            "1.2.29.207.213", 
                            "1.2.29.207.214", 
                            "1.2.29.207.215", 
                            "1.2.29.207.216"), 
                       
                       "Personal care services" =
                          c("1.2.29.217.218", 
                            "1.2.29.217.219"), 
                           
                       "Recreation equipment and related services" =
                          c("1.2.30.31.220", 
                            "1.2.30.31.221", 
                            "1.2.30.31.222", 
                            "1.2.30.31.223", 
                            "1.2.30.31.224", 
                            "1.2.30.31.225", 
                            "1.2.30.31.229", 
                            "1.2.30.31.232", 
                            "1.2.30.31.233"),
                            
                       "Home entertainment equipment and services" =    
                          c("1.2.30.32.234", 
                            "1.2.30.32.242"), 
                       
                       "Recreation services" =
                          c("1.2.30.33.245", 
                            "1.2.30.33.252", 
                            "1.2.30.33.255", 
                            "1.2.30.33.256"),
                       
                       "Recreation vehicles and associated services" =
                          c("1.2.30.34.257", 
                            "1.2.30.34.262"), 
                       
                       "Tuition fees" =
                          c("1.2.35.267.268", 
                            "1.2.35.267.269", 
                            "1.2.35.267.270", 
                            "1.2.35.267.271", 
                            "1.2.35.267.272"), 
                       
                       "Tobacco products and smokers' supplies" =
                          c("1.2.37.279.280", 
                            "1.2.37.279.323", 
                            "1.2.37.279.281"), 
                       
                       "Alcoholic beverages" =
                          c("1.2.37.282.283", 
                            "1.2.37.282.284", 
                            "1.2.37.282.285"),  
                        
                       "Other games of chance" =    
                          c("1.2.38.287.288", 
                            "1.2.38.287.289"),
                       
                       "Financial services" =
                          c("1.2.39.290.291", 
                            "1.2.39.290.292", 
                            "1.2.39.290.293", 
                            "1.2.39.290.294"), 
                       
                       "Other miscellaneous goods and services" =
                          c("1.2.39.295.296", 
                            "1.2.39.295.297", 
                            "1.2.39.295.298", 
                            "1.2.39.295.299", 
                            "1.2.39.295.300", 
                            "1.2.39.295.301", 
                            "1.2.39.295.302", 
                            "1.2.39.295.303", 
                            "1.2.39.295.304", 
                            "1.2.39.295.305", 
                            "1.2.39.295.306")
  )}

########## Function 05 ##
Exp_fn_lvl05 <- function(element) {
  ## This groups the fifth-level codes
  forcats::fct_collapse(element,
                        "Rented living quarters" = 
                          c("1.2.6.7.8.53", 
                            "1.2.6.7.8.54", 
                            "1.2.6.7.8.55", 
                            "1.2.6.7.8.56"), 
                        
                        "Owned living quarters" =
                          c("1.2.6.7.9.57", 
                            "1.2.6.7.9.58", 
                            "1.2.6.7.9.59", 
                            "1.2.6.7.9.60", 
                            "1.2.6.7.9.61", 
                            "1.2.6.7.9.62"), 
                        
                        "Water, fuel and electricity for principal accomodation" =
                          c("1.2.6.7.10.69", 
                            "1.2.6.7.10.70", 
                            "1.2.6.7.10.71", 
                            "1.2.6.7.10.72"), 
                        
                        "Owned secondary residences" =
                          c("1.2.6.11.73.74", 
                            "1.2.6.11.73.318", 
                            "1.2.6.11.73.76", 
                            "1.2.6.11.73.319", 
                            "1.2.6.11.73.320", 
                            "1.2.6.11.73.78"), 
 
                        "Accomodation away from home" =                            
                          c("1.2.6.11.80.81", 
                            "1.2.6.11.80.82"), 
                            
                        "Telephone" =    
                          c("1.2.12.13.83.84", 
                            "1.2.12.13.83.85", 
                            "1.2.12.13.83.86"), 
                        
                        "Household appliances" =    
                          c("1.2.14.16.17.116", 
                            "1.2.14.16.17.117", 
                            "1.2.14.16.17.118", 
                            "1.2.14.16.17.119", 
                            "1.2.14.16.17.120", 
                            "1.2.14.16.17.121", 
                            "1.2.14.16.17.122"), 
                        
                        "Other household equipment" =
                          c("1.2.14.16.123.124", 
                            "1.2.14.16.123.125", 
                            "1.2.14.16.123.126", 
                            "1.2.14.16.123.127"), 
                            
                       "Footwear (women and girls 4 years+)" =     
                          c("1.2.18.132.134.135", 
                            "1.2.18.132.134.136"), 
                       
                       "Watches and jewellery (women and girls 4 years+)" =
                          c("1.2.18.132.138.139", 
                            "1.2.18.132.138.140"), 
                       
                       "Footwear (men and boys 4 years+)" =                      
                          c("1.2.18.141.143.144", 
                            "1.2.18.141.143.145"), 
                       
                       "Watches and jewellery (men and boys 4 years+)" =                       
                          c("1.2.18.141.147.148", 
                            "1.2.18.141.147.149"), 
                       
                       "Private use automobiles, vans and trucks" =
                          c("1.2.23.24.159.160", 
                            "1.2.23.24.159.164", 
                            "1.2.23.24.159.165"), 
                            
                      "Automobile, van and truck operations" =      
                          c("1.2.23.24.171.172", 
                            "1.2.23.24.171.173", 
                            "1.2.23.24.171.174", 
                            "1.2.23.24.171.175", 
                            "1.2.23.24.171.176", 
                            "1.2.23.24.171.177", 
                            "1.2.23.24.171.179", 
                            "1.2.23.24.171.178", 
                            "1.2.23.24.171.180"), 
                        
                      "Health care services" =  
                          c("1.2.26.27.192.193", 
                            "1.2.26.27.192.194", 
                            "1.2.26.27.192.195", 
                            "1.2.26.27.192.196"), 
                            
                      "Eye-care goods and services" =      
                          c("1.2.26.27.197.198", 
                            "1.2.26.27.197.199", 
                            "1.2.26.27.197.200"), 
                            
                      "Makeup, skin care, manicure and fragrance products" =      
                          c("1.2.29.207.209.210", 
                            "1.2.29.207.209.211"), 
                     
                      "Computer equipment and supplies" =       
                          c("1.2.30.31.225.226", 
                            "1.2.30.31.225.227", 
                            "1.2.30.31.225.228", 
                            "1.2.30.31.225.317", 
                            "1.2.30.31.225.321", 
                            "1.2.30.31.225.322"), 
                      
                      "Photographic goods and services" =
                          c("1.2.30.31.229.230", 
                            "1.2.30.31.229.231"), 
                            
                      "Home entertainment equipment" =      
                          c("1.2.30.32.234.235", 
                            "1.2.30.32.234.236", 
                            "1.2.30.32.234.240", 
                            "1.2.30.32.234.241"), 
                            
                      "Home entertainment services" =
                          c("1.2.30.32.242.243", 
                            "1.2.30.32.242.244"), 
                      
                      "Entertainment" =
                          c("1.2.30.33.245.246", 
                            "1.2.30.33.245.247", 
                            "1.2.30.33.245.248", 
                            "1.2.30.33.245.249"), 
                            
                      "Use of recreation facilities" =      
                          c("1.2.30.33.252.253", 
                            "1.2.30.33.252.254"), 
                      
                      "Purchase of recreational vehicles" =
                          c("1.2.30.34.257.258", 
                            "1.2.30.34.257.259", 
                            "1.2.30.34.257.261", 
                            "1.2.30.34.257.260"),
                      
                      "Operation of recreational vehicles" =
                          c("1.2.30.34.262.263", 
                            "1.2.30.34.262.264", 
                            "1.2.30.34.262.265", 
                            "1.2.30.34.262.266")
                      )}

########## Function 06 ##
Exp_fn_lvl06 <- function(element) {
  ## This groups the sixth-level codes
  forcats::fct_collapse(element,
                        "Other expenditures for owned living quarters" = 
                          c("1.2.6.7.9.62.63", 
                            "1.2.6.7.9.62.64", 
                            "1.2.6.7.9.62.65", 
                            "1.2.6.7.9.62.67", 
                            "1.2.6.7.9.62.68", 
                            "1.2.6.7.9.62.316"), 
                            
                        "Purchase of automobiles, vans and trucks" =    
                          c("1.2.23.24.159.160.161",
                            "1.2.23.24.159.160.162", 
                            "1.2.23.24.159.160.163"), 
                            
                        "Fees for leased automobiles, vans and trucks" =
                          c("1.2.23.24.159.165.166",
                            "1.2.23.24.159.165.169"), 
                        
                        "Drivers' licenses andtests, and driving lessons" =
                          c("1.2.23.24.171.180.181", 
                            "1.2.23.24.171.180.182"),
                        
                        "Video equipment" =
                          c("1.2.30.32.234.236.237", 
                            "1.2.30.32.234.236.238", 
                            "1.2.30.32.234.236.239")
                        )}

########## Function 07 ##
Exp_fn_lvl07 <- function(element) {
  ## This groups the seventh-level codes
  forcats::fct_collapse(element,
                        "Regular fees for leased automobiles, vans and trucks" = 
                          c("1.2.23.24.159.165.166.167", 
                            "1.2.23.24.159.165.166.168")
  )}


######## COMPUTE THE HIERARCHY VARIABLES ############################
  
###### Group by Expenditure Hierarchies
b1 <- as_tibble(b %>%
                  mutate(Exp_lvl01 = factor(b$Expenditure_Cat_Hierarchy, 
                                            levels = c("1", "1.2", "1.40", "1.41", "1.42")),
                         Exp_lvl01 = Exp_lvl01_fn(Exp_lvl01)                  ))



